import{i as D,h as H,l as L,r as p,j as T,R as O,k as J,F as Q,P as X,p as Z}from"./sleep.CbAukOL6.js";import{u as G,a as ee}from"./FormListContext.wZgmYX6s.js";import{F as te,a as oe}from"./FormTitle.Cr1SZ7VX.js";import{u as ae}from"./useFieldValue.UFyngvtQ.js";import{ah as le,o as K,O as E,ai as ne,a2 as I,F as q,i as ie,P as re,B as ue}from"./theme.Cs0iWRp3.js";import{d as V,f as C,e as f,k as i,s as de,w as ce,a0 as z,i as se}from"./framework.LW9JDvVy.js";import{o as ve,a as me}from"./index.DELBPES_.js";import"./index.DjY3Qf_R.js";import"./index.Dvj91dNc.js";import"./index.Dw6vpUqL.js";import"./install.BalIz2Dd.js";import"./validate.EEzCsTff.js";import"./useIntl.BQXbQ8uP.js";import"./index.BMo0A0P6.js";const fe=["formSet","divider"];var ye=V({name:"FormListItem",inheritAttrs:!1,props:{index:{type:Number,default:0},originName:{type:[String,Array],default:()=>[]},fieldKey:{type:Number,default:0},items:{type:Array,default:()=>[]},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},copyIconProps:{type:[Object,Boolean],default:void 0},deleteIconProps:{type:[Object,Boolean],default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},count:{type:Number,default:0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},record:{type:Object,default:void 0},action:{type:Object,required:!0},onRemove:{type:Function,required:!0},onCopy:{type:Function,required:!0}},emits:["remove","copy"],setup(e,{slots:g}){const{formatItems:w,prefixCls:c,formData:A,grid:u}=D(),b=G(),_=H(),F=C(!1),v=C(!1),y=f(()=>e.index),h=f(()=>{var l;return[(l=b.listName)==null?void 0:l.value,e.originName,y.value].filter(o=>o!==void 0).flat(1)}),j=f(()=>[b.listKey,L(e.originName),e.fieldKey].filter(l=>l!==void 0).flat(1).join("_")),N=l=>{var o;const n=[];return(o=l.dependencies)==null||o.forEach(r=>{const s=L(r);s&&n.push([...h.value,s].filter(S=>S!==void 0).flat(1))}),n},B=l=>I(l).filter(o=>{var n;return!fe.includes((n=o.fieldType)!=null?n:"")}).map(o=>{var n,r,s,S,x,$;if(o.fieldType===X.GROUP)return o.children=B((r=p((n=o.children)!=null?n:[],A.value))!=null?r:[]),o;const W=(s=o.originName)!=null?s:o.name,M=(S=o.originKey)!=null?S:o.key,R=L(o.name),U=y.value===0||e.alwaysShowItemLabel?o.title:void 0,k={...o,title:U,originKey:M,key:`${j.value}_${(x=o.key)!=null?x:R?.join("_")}`,originName:W,name:[...($=h?.value)!=null?$:[],R].filter(Y=>Y!==void 0).flat(1)};return Array.isArray(o.dependencies)&&o.dependencies.length>0&&o.name&&(k.dependencies=N(k)),k}),t=f(()=>{var l,o,n;const r=(o=p((l=e.items)!=null?l:[],A.value))!=null?o:[];return(n=w?.(B(r)))!=null?n:[]}),a=f(()=>{var l;if(e.readonly||e.deleteIconProps===!1||e.min===e.count)return null;const{icon:o,tooltipText:n}=(l=e.deleteIconProps)!=null?l:{};let r=i(le,null,null);if(o){const s=T(o,_);r=i(O,{vnode:s,props:{defaultDom:r}},null)}return i(E,{size:"small",spinning:F.value},{default:()=>[i(K,{title:n??"删除此行",key:"delete"},{default:()=>[i("div",{class:`${c}-list-action-icon ${c}-list-action-remove`,onClick:d},[r])]})]})}),m=f(()=>{var l;if(e.readonly||e.copyIconProps===!1||e.max===e.count)return null;const{icon:o,tooltipText:n}=(l=e.copyIconProps)!=null?l:{};let r=i(ne,null,null);if(o){const s=T(o,_);r=i(O,{vnode:s,props:{defaultDom:r}},null)}return i(E,{size:"small",spinning:v.value},{default:()=>[i(K,{title:n??"复制此行",key:"copy"},{default:()=>[i("div",{class:`${c}-list-action-icon ${c}-list-action-copy`,onClick:P},[r])]})]})}),d=async()=>{F.value=!0,await e.onRemove(y.value),F.value=!1},P=async()=>{v.value=!0,await e.onCopy(y.value),v.value=!1};return ee({isList:!0,originName:e.originName,index:y,fieldKey:e.fieldKey,listName:h,listKey:j.value,rowData:f(()=>e.record)}),()=>{var l,o;if(!t.value.length)return null;const n=i("div",{class:`${c}-list-action`},[m.value,a.value]),r=g.action?i(O,{vnode:g.action,props:{index:y.value,action:e.action,defaultDom:n,record:(l=e.record)!=null?l:{}}},null):n,s=i("div",{class:`${c}-list-item-container`,style:{width:u?.value?"100%":void 0}},[i(J,{rowProps:e.rowProps},{default:()=>[i(Q,{list:t.value},null)]})]);return g.item?i(O,{vnode:g.item,props:{listDom:s,actionDom:r,record:(o=e.record)!=null?o:{}}},null):i("div",{class:`${c}-list-item`,style:"display: flex; align-items: flex-end;"},[s,r])}}});function be(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!se(e)}var Pe=V({name:"FormListContainer",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:g}){const w=C(!1),c=C([]),{prefixCls:A}=D(),u=de({keys:[],id:0}),{fieldValue:b,onValueChange:_}=ae({namePath:f(()=>e.name),initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform}),F=q.useInjectFormItemContext(),v=f(()=>{var t,a;return(a=(t=b.value)==null?void 0:t.length)!=null?a:0}),y={add:async(t,a)=>{var m,d,P;if((m=e.actionGuard)!=null&&m.beforeAddRow&&!await((d=e.actionGuard)==null?void 0:d.beforeAddRow(t,a,v.value)))return!1;const l=I((P=b.value)!=null?P:[]);return a!==void 0&&a>=0&&a<=l.length?(u.value.keys=[...u.value.keys.slice(0,a),u.value.id,...u.value.keys.slice(a)],_(I([...l.slice(0,a),t,...l.slice(a)])),F.onFieldChange()):(u.value.keys=[...u.value.keys,u.value.id],_(I([...l,t])),F.onFieldChange()),u.value.id+=1,Promise.resolve().then(()=>{var o;(o=e.onAfterAdd)==null||o.call(e,t,a,v.value)}),!0},remove:async t=>{var a,m,d;if((a=e.actionGuard)!=null&&a.beforeRemoveRow&&!await((m=e.actionGuard)==null?void 0:m.beforeRemoveRow(t,v.value)))return!1;const P=I((d=b.value)!=null?d:[]),l=new Set(Array.isArray(t)?t:[t]);if(l.size<=0)return!1;u.value.keys=u.value.keys.filter((n,r)=>!l.has(r));const o=P.filter((n,r)=>!l.has(r));return _(o),F.onFieldChange(),Promise.resolve().then(()=>{var n;(n=e.onAfterRemove)==null||n.call(e,t,v.value)}),!0}},h=async()=>{var t;if(e.creatorButtonProps!==!1){w.value=!0;let a=v.value;((t=e.creatorButtonProps)==null?void 0:t.position)==="top"&&(a=0),await y.add(I(p(e.creatorRecord)||{}),a),w.value=!1}},j=async t=>{await y.remove(t)},N=async t=>{await y.add(I(b.value[t]),v.value+1)};ce(b,()=>{var t;ie(c.value,b.value)||(c.value=I((t=b.value)!=null?t:[]))},{immediate:!0});const B=f(()=>{var t,a;if(e.readonly||e.creatorButtonProps===!1||v.value===e.max)return null;const{position:m="bottom",creatorButtonText:d="添加一行数据"}=(t=e.creatorButtonProps)!=null?t:{},{block:P=!0,type:l="dashed",...o}=ve((a=e.creatorButtonProps)!=null?a:{},["position","creatorButtonText"]),n=i(ue,z({class:`${A}-list-creator-button-${m}`,type:l,block:P,icon:i(re,null,null)},o,{loading:w.value,onClick:h}),be(d)?d:{default:()=>[d]});return g.creator?i(O,{vnode:g.creator,props:{defaultDom:n,add:y.add,count:v.value}},null):n});return()=>{var t,a,m,d,P,l,o;return e.readonly&&!((t=c.value)!=null&&t.length)&&(c.value=[{}]),i("div",{style:"width: max-content; max-width: 100%; min-width: 100%; ",class:{[`${A}-list-container`]:!0,[`${A}-list-empty`]:((m=(a=b.value)!=null?a:[])==null?void 0:m.length)==0}},[e.creatorButtonProps!==!1&&((d=e.creatorButtonProps)==null?void 0:d.position)==="top"&&B.value,((P=c.value)!=null?P:[]).map((n,r)=>{let s=u.value.keys[r];return s===void 0&&(u.value.keys[r]=u.value.id,s=u.value.keys[r],u.value.id+=1),i(ye,{key:s,fieldKey:s,originName:e.originName,index:r,items:e.items,rowProps:e.rowProps,min:e.min,max:e.max,count:v.value,record:n,alwaysShowItemLabel:e.alwaysShowItemLabel,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,action:y,readonly:e.readonly,onRemove:j,onCopy:N},{action:g.action,item:g.item})}),e.creatorButtonProps!==!1&&(((l=e.creatorButtonProps)==null?void 0:l.position)==="bottom"||((o=e.creatorButtonProps)==null?void 0:o.position)===void 0)&&B.value])}}});const ge=["autoLink","colon","hasFeedback","labelAlign","labelCol","required","validateFirst","validateStatus","validateTrigger","wrapperCol","required"];var ke=V({name:"FormList",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},colProps:{type:Object,default:void 0},rowProps:{type:Object,default:void 0},formItemProps:{type:[Object,Function],default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},readonly:{type:Boolean,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},rules:{type:[Object,Array,Function],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},isValidateList:{type:Boolean,default:void 0},emptyListMessage:{type:String,default:"列表不能为空"},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:g}){const{formatItems:w,formData:c,prefixCls:A,readonly:u}=D(),b=G(),_=f(()=>{var t;return p((t=e.readonly)!=null?t:u?.value,c.value)}),F=f(()=>{var t;return((t=b.listName)==null?void 0:t.value)===void 0?[e.originName].flat(1):[b.listName.value,e.originName].flat(1)}),v=f(()=>{var t;return(t=p(e.formItemProps,c.value))!=null?t:{}}),y=f(()=>{var t;return me({rules:_.value?[]:p((t=e.rules)!=null?t:v.value.rules,c.value),...Z(v.value,ge)})}),h=f(()=>{var t,a;return(a=w?.(p((t=e.items)!=null?t:[],c.value)))!=null?a:[]}),j=f(()=>{const t={};return e.title&&(t.label=()=>i(te,{title:e.title,tooltip:e.tooltip},null)),t}),N=(...t)=>{var a;(a=e.onAfterAdd)==null||a.call(e,...t)},B=(...t)=>{var a;(a=e.onAfterRemove)==null||a.call(e,...t)};return()=>{var t;if(!((t=e.name)!=null&&t.length)||!h.value.length)return null;const a=e.isValidateList?[{validator:(m,d)=>!d||d.length===0?Promise.reject(new Error(e.emptyListMessage)):Promise.resolve(),required:!0}]:p(e.rules,c.value);return i(oe,{colProps:e.colProps},{default:()=>{var m,d;return[i("div",{class:`${A}-list`},[i(q.Item,z({required:_.value?!1:(d=(m=y.value)==null?void 0:m.rules)==null?void 0:d.some(P=>P.required),name:a?.length?F.value:void 0,rules:_.value?void 0:a},y.value),{default:()=>[i(Pe,{name:e.name,originName:e.originName,title:e.title,tooltip:e.tooltip,rowProps:e.rowProps,initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform,items:h.value,min:e.min,max:e.max,readonly:_.value,alwaysShowItemLabel:e.alwaysShowItemLabel,creatorRecord:e.creatorRecord,creatorButtonProps:e.creatorButtonProps,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,actionGuard:e.actionGuard,onAfterAdd:N,onAfterRemove:B},{...g})],...j.value})])]}})}}});export{ke as default};
