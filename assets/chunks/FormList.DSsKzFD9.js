import{b as L,u as E,d as C,r as F,g as x,R as S,c as z,F as W,e as M,f as U,o as Y,p as H}from"./index.nUjjoqIc.js";import{u as T,a as J}from"./FormListContext.MyNuQUS7.js";import{a as Q,F as X}from"./FormTitle.BPvLRodN.js";import{u as Z}from"./useFieldValue.O74F_nqK.js";import{ac as ee,p as D,T as $,ad as te,k as I,o as K,t as ne,B as ae,ae as oe}from"./theme.jf2kyIww.js";import{d as V,f as R,e as c,k as a,s as le,w as ie,$ as _,i as ue}from"./framework.eaSbAno9.js";const re=["formSet","divider"],de=V({name:"FormListItem",inheritAttrs:!1,props:{index:{type:Number,default:0},originName:{type:[String,Array],default:()=>[]},fieldKey:{type:Number,default:0},items:{type:Array,default:()=>[]},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},copyIconProps:{type:[Object,Boolean],default:void 0},deleteIconProps:{type:[Object,Boolean],default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},count:{type:Number,default:0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},record:{type:Object,default:void 0},action:{type:Object,required:!0},onRemove:{type:Function,required:!0},onCopy:{type:Function,required:!0}},emits:["remove","copy"],setup(e,{slots:y}){const{formatItems:h,prefixCls:u,formData:P,grid:r}=L(),f=T(),v=E(),g=R(!1),d=R(!1),s=c(()=>e.index),b=c(()=>[f.listName?.value,e.originName,s.value].filter(l=>l!==void 0).flat(1)),p=c(()=>[f.listKey,C(e.originName),e.fieldKey].filter(l=>l!==void 0).flat(1).join("_")),B=l=>{const n=[];return l.dependencies?.forEach(m=>{const w=C(m);w&&n.push([...b.value,w].filter(O=>O!==void 0).flat(1))}),n},A=l=>I(l).filter(n=>!re.includes(n.fieldType??"")).map(n=>{if(n.fieldType===M.GROUP)return n.children=A(F(n.children??[],P.value)??[]),n;const m=n.originName??n.name,w=n.originKey??n.key,O=C(n.name),G=s.value===0||e.alwaysShowItemLabel?n.title:void 0,k={...n,title:G,originKey:w,key:`${p.value}_${n.key??O?.join("_")}`,originName:m,name:[...b?.value??[],O].filter(q=>q!==void 0).flat(1)};return Array.isArray(n.dependencies)&&n.dependencies.length>0&&n.name&&(k.dependencies=B(k)),k}),t=c(()=>{const l=F(e.items??[],P.value)??[];return h?.(A(l))??[]}),o=c(()=>{if(e.readonly||e.deleteIconProps===!1||e.min===e.count)return null;const{icon:l,tooltipText:n}=e.deleteIconProps??{};let m=a(ee,null,null);if(l){const w=x(l,v);m=a(S,{vnode:w,props:{defaultDom:m}},null)}return a(D,{size:"small",spinning:g.value},{default:()=>[a($,{title:n??"删除此行",key:"delete"},{default:()=>[a("div",{class:`${u}-list-action-icon ${u}-list-action-remove`,onClick:N},[m])]})]})}),i=c(()=>{if(e.readonly||e.copyIconProps===!1||e.max===e.count)return null;const{icon:l,tooltipText:n}=e.copyIconProps??{};let m=a(te,null,null);if(l){const w=x(l,v);m=a(S,{vnode:w,props:{defaultDom:m}},null)}return a(D,{size:"small",spinning:d.value},{default:()=>[a($,{title:n??"复制此行",key:"copy"},{default:()=>[a("div",{class:`${u}-list-action-icon ${u}-list-action-copy`,onClick:j},[m])]})]})}),N=async()=>{g.value=!0,await e.onRemove(s.value),g.value=!1},j=async()=>{d.value=!0,await e.onCopy(s.value),d.value=!1};return J({isList:!0,originName:e.originName,index:s,fieldKey:e.fieldKey,listName:b,listKey:p.value,rowData:c(()=>e.record)}),()=>{if(!t.value.length)return null;const l=a("div",{class:`${u}-list-action`},[i.value,o.value]),n=y.action?a(S,{vnode:y.action,props:{index:s.value,action:e.action,defaultDom:l,record:e.record??{}}},null):l,m=a("div",{class:`${u}-list-item-container`,style:{width:r?.value?"100%":void 0}},[a(z,{rowProps:e.rowProps},{default:()=>[a(W,{list:t.value},null)]})]);return y.item?a(S,{vnode:y.item,props:{listDom:m,actionDom:n,record:e.record??{}}},null):a("div",{class:`${u}-list-item`,style:"display: flex; align-items: flex-end;"},[m,n])}}});function ce(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!ue(e)}const se=V({name:"FormListContainer",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:String,default:void 0},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:y}){const h=R(!1),u=R([]),{prefixCls:P}=L(),r=le({keys:[],id:0}),{fieldValue:f,onValueChange:v}=Z({namePath:c(()=>e.name),initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform}),g=K.useInjectFormItemContext(),d=c(()=>f.value?.length??0),s={add:async(t,o)=>{if(e.actionGuard?.beforeAddRow&&!await e.actionGuard?.beforeAddRow(t,o,d.value))return!1;const i=I(f.value??[]);return o!==void 0&&o>=0&&o<=i.length?(r.value.keys=[...r.value.keys.slice(0,o),r.value.id,...r.value.keys.slice(o)],v(I([...i.slice(0,o),t,...i.slice(o)])),g.onFieldChange()):(r.value.keys=[...r.value.keys,r.value.id],v(I([...i,t])),g.onFieldChange()),r.value.id+=1,Promise.resolve().then(()=>{e.onAfterAdd?.(t,o,d.value)}),!0},remove:async t=>{if(e.actionGuard?.beforeRemoveRow&&!await e.actionGuard?.beforeRemoveRow(t,d.value))return!1;const o=I(f.value??[]),i=new Set(Array.isArray(t)?t:[t]);if(i.size<=0)return!1;r.value.keys=r.value.keys.filter((j,l)=>!i.has(l));const N=o.filter((j,l)=>!i.has(l));return v(N),g.onFieldChange(),Promise.resolve().then(()=>{e.onAfterRemove?.(t,d.value)}),!0}},b=async()=>{if(e.creatorButtonProps!==!1){h.value=!0;let t=d.value;e.creatorButtonProps?.position==="top"&&(t=0),await s.add(I(F(e.creatorRecord)||{}),t),h.value=!1}},p=async t=>{await s.remove(t)},B=async t=>{await s.add(I(f.value[t]),d.value+1)};ie(f,()=>{ne(u.value,f.value)||(u.value=I(f.value??[]))},{immediate:!0});const A=c(()=>{if(e.readonly||e.creatorButtonProps===!1||d.value===e.max)return null;const{position:t="bottom",creatorButtonText:o="添加一行数据"}=e.creatorButtonProps??{},{block:i=!0,type:N="dashed",...j}=U(e.creatorButtonProps??{},["position","creatorButtonText"]),l=a(ae,_({class:`${P}-list-creator-button-${t}`,type:N,block:i,icon:a(oe,null,null)},j,{loading:h.value,onClick:b}),ce(o)?o:{default:()=>[o]});return y.creator?a(S,{vnode:y.creator,props:{defaultDom:l,add:s.add,count:d.value}},null):l});return()=>(e.readonly&&!u.value?.length&&(u.value=[{}]),a("div",{style:"width: max-content; max-width: 100%; min-width: 100%; ",class:{[`${P}-list-container`]:!0,[`${P}-list-empty`]:(f.value??[])?.length==0}},[e.creatorButtonProps!==!1&&e.creatorButtonProps?.position==="top"&&A.value,(u.value??[]).map((t,o)=>{let i=r.value.keys[o];return i===void 0&&(r.value.keys[o]=r.value.id,i=r.value.keys[o],r.value.id+=1),a(de,{key:i,fieldKey:i,originName:e.originName,index:o,items:e.items,rowProps:e.rowProps,min:e.min,max:e.max,count:d.value,record:t,alwaysShowItemLabel:e.alwaysShowItemLabel,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,action:s,readonly:e.readonly,onRemove:p,onCopy:B},{action:y.action,item:y.item})}),e.creatorButtonProps!==!1&&(e.creatorButtonProps?.position==="bottom"||e.creatorButtonProps?.position===void 0)&&A.value]))}}),fe=["autoLink","colon","hasFeedback","labelAlign","labelCol","required","validateFirst","validateStatus","validateTrigger","wrapperCol","required"],we=V({name:"FormList",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:String,default:void 0},colProps:{type:Object,default:void 0},rowProps:{type:Object,default:void 0},formItemProps:{type:[Object,Function],default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},readonly:{type:Boolean,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},rules:{type:[Object,Array,Function],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},isValidateList:{type:Boolean,default:void 0},emptyListMessage:{type:String,default:"列表不能为空"},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:y}){const{formatItems:h,formData:u,prefixCls:P,readonly:r}=L(),f=T(),v=c(()=>F(e.readonly??r?.value,u.value)),g=c(()=>f.listName?.value===void 0?[e.originName].flat(1):[f.listName.value,e.originName].flat(1)),d=c(()=>F(e.formItemProps,u.value)??{}),s=c(()=>Y({rules:v.value?[]:F(e.rules??d.value.rules,u.value),...H(d.value,fe)})),b=c(()=>h?.(F(e.items??[],u.value))??[]),p=c(()=>{const t={};return e.title&&(t.label=()=>a(Q,{title:e.title,tooltip:e.tooltip},null)),t}),B=(...t)=>{e.onAfterAdd?.(...t)},A=(...t)=>{e.onAfterRemove?.(...t)};return()=>{if(!e.name?.length||!b.value.length)return null;const t=e.isValidateList?[{validator:(o,i)=>!i||i.length===0?Promise.reject(new Error(e.emptyListMessage)):Promise.resolve(),required:!0}]:F(e.rules,u.value);return a(X,{colProps:e.colProps},{default:()=>[a("div",{class:`${P}-list`},[a(K.Item,_({required:v.value?!1:s.value?.rules?.some(o=>o.required),name:t?.length?g.value:void 0,rules:v.value?void 0:t},s.value),{default:()=>[a(se,{name:e.name,originName:e.originName,title:e.title,tooltip:e.tooltip,rowProps:e.rowProps,initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform,items:b.value,min:e.min,max:e.max,readonly:v.value,alwaysShowItemLabel:e.alwaysShowItemLabel,creatorRecord:e.creatorRecord,creatorButtonProps:e.creatorButtonProps,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,actionGuard:e.actionGuard,onAfterAdd:B,onAfterRemove:A},{...y})],...p.value})])]})}}});export{we as default};
