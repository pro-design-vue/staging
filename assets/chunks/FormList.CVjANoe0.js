import{B as V,$ as q,A as Q,a0 as D,G as B,a1 as Z,J as K,L as O,Q as G,a2 as E,a3 as H,a4 as X,N as ee,K as te,Z as I,d as le,F as W,Y as ae,a5 as oe,t as ne,a6 as ie,V as ue,W as re}from"./theme.CA54E1SO.js";import{F as de,a as ce}from"./FormTitle.65wEI2zO.js";import{u as se}from"./useFieldValue.Di-fMYk9.js";import{d as x,f as C,e as s,k as n,s as ve,w as me,a0 as z,i as ye}from"./framework.BBTDMeVS.js";const fe=["formSet","divider"];var we=x({name:"FormListItem",inheritAttrs:!1,props:{index:{type:Number,default:0},originName:{type:[String,Array],default:()=>[]},fieldKey:{type:Number,default:0},title:{type:[String,Object,Function],default:void 0},items:{type:Array,default:()=>[]},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},copyIconProps:{type:[Object,Boolean],default:void 0},deleteIconProps:{type:[Object,Boolean],default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},alwaysShowRowTitle:{type:Boolean,default:void 0},rowTitle:{type:String,default:void 0},rowTitleStyle:{type:Object,default:void 0},count:{type:Number,default:0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},record:{type:Object,default:void 0},action:{type:Object,required:!0},onRemove:{type:Function,required:!0},onCopy:{type:Function,required:!0}},emits:["remove","copy"],setup(e,{slots:P}){const{formatItems:S,prefixCls:r,formData:A,grid:d}=V(),w=q(),_=Q(),h=C(!1),v=C(!1),y=s(()=>e.index),F=s(()=>{var o;return[(o=w.listName)==null?void 0:o.value,e.originName,y.value].filter(l=>l!==void 0).flat(1)}),T=s(()=>[w.listKey,D(e.originName),e.fieldKey].filter(o=>o!==void 0).flat(1).join("_")),j=o=>{var l;const i=[];return(l=o.dependencies)==null||l.forEach(u=>{const g=D(u);g&&i.push([...F.value,g].filter(N=>N!==void 0).flat(1))}),i},R=o=>I(o).filter(l=>{var i;return!fe.includes((i=l.fieldType)!=null?i:"")}).map(l=>{var i,u,g,N,$,p;if(l.fieldType===le.GROUP)return l.children=R((u=B((i=l.children)!=null?i:[],A.value))!=null?u:[]),l;const Y=(g=l.originName)!=null?g:l.name,M=(N=l.originKey)!=null?N:l.key,L=D(l.name),U=y.value===0||e.alwaysShowItemLabel?l.title:void 0,k={...l,title:U,originKey:M,key:`${T.value}_${($=l.key)!=null?$:L?.join("_")}`,originName:Y,name:[...(p=F?.value)!=null?p:[],L].filter(J=>J!==void 0).flat(1)};return Array.isArray(l.dependencies)&&l.dependencies.length>0&&l.name&&(k.dependencies=j(k)),k}),t=s(()=>{var o,l,i;const u=(l=B((o=e.items)!=null?o:[],A.value))!=null?l:[];return(i=S?.(R(u)))!=null?i:[]}),a=s(()=>e.alwaysShowRowTitle&&e.rowTitle),m=s(()=>{var o;if(e.readonly||e.deleteIconProps===!1||e.min===e.count)return null;const{icon:l,tooltipText:i}=(o=e.deleteIconProps)!=null?o:{};let u=n(Z,null,null);if(l){const g=K(l,_);u=n(O,{vnode:g,props:{defaultDom:u}},null)}return n(E,{size:"small",spinning:h.value},{default:()=>[n(G,{title:i??"删除此行",key:"delete"},{default:()=>[n("div",{class:`${r}-list-action-icon ${r}-list-action-remove`,onClick:b},[u])]})]})}),c=s(()=>{var o;if(e.readonly||e.copyIconProps===!1||e.max===e.count)return null;const{icon:l,tooltipText:i}=(o=e.copyIconProps)!=null?o:{};let u=n(H,null,null);if(l){const g=K(l,_);u=n(O,{vnode:g,props:{defaultDom:u}},null)}return n(E,{size:"small",spinning:v.value},{default:()=>[n(G,{title:i??"复制此行",key:"copy"},{default:()=>[n("div",{class:`${r}-list-action-icon ${r}-list-action-copy`,onClick:f},[u])]})]})}),b=async()=>{h.value=!0,await e.onRemove(y.value),h.value=!1},f=async()=>{v.value=!0,await e.onCopy(y.value),v.value=!1};return X({isList:!0,originName:e.originName,index:y,fieldKey:e.fieldKey,listName:F,listKey:T.value,rowData:s(()=>e.record)}),()=>{var o,l;if(!t.value.length)return null;const i=n("div",{class:`${r}-list-action`},[c.value,m.value]),u=P.action?n(O,{vnode:P.action,props:{index:y.value,action:e.action,defaultDom:i,record:(o=e.record)!=null?o:{}}},null):i,g=n("div",{class:`${r}-list-item-container`,style:{width:d?.value?"100%":void 0}},[n(ee,{rowProps:e.rowProps},{default:()=>[n(te,{list:t.value},null)]})]);return P.item?n(O,{vnode:P.item,props:{listDom:g,actionDom:u,record:(l=e.record)!=null?l:{}}},null):n("div",{class:`${r}-list-item-wrapper`},[a.value&&n("div",{class:`${r}-list-item-title`},[n("div",{style:e.rowTitleStyle},[e.rowTitle,e.index+1]),u]),n("div",{class:`${r}-list-item`,style:"display: flex; align-items: flex-end;"},[g,!a.value&&u])])}}});function be(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!ye(e)}var ge=x({name:"FormListContainer",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},alwaysShowRowTitle:{type:Boolean,default:void 0},rowTitle:{type:String,default:void 0},rowTitleStyle:{type:Object,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:P}){const S=C(!1),r=C([]),{prefixCls:A}=V(),d=ve({keys:[],id:0}),{fieldValue:w,onValueChange:_}=se({namePath:s(()=>e.name),initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform}),h=W.useInjectFormItemContext(),v=s(()=>{var t,a;return(a=(t=w.value)==null?void 0:t.length)!=null?a:0}),y={add:async(t,a)=>{var m,c,b;if((m=e.actionGuard)!=null&&m.beforeAddRow&&!await((c=e.actionGuard)==null?void 0:c.beforeAddRow(t,a,v.value)))return!1;const f=I((b=w.value)!=null?b:[]);return a!==void 0&&a>=0&&a<=f.length?(d.value.keys=[...d.value.keys.slice(0,a),d.value.id,...d.value.keys.slice(a)],_(I([...f.slice(0,a),t,...f.slice(a)])),h.onFieldChange()):(d.value.keys=[...d.value.keys,d.value.id],_(I([...f,t])),h.onFieldChange()),d.value.id+=1,Promise.resolve().then(()=>{var o;(o=e.onAfterAdd)==null||o.call(e,t,a,v.value)}),!0},remove:async t=>{var a,m,c;if((a=e.actionGuard)!=null&&a.beforeRemoveRow&&!await((m=e.actionGuard)==null?void 0:m.beforeRemoveRow(t,v.value)))return!1;const b=I((c=w.value)!=null?c:[]),f=new Set(Array.isArray(t)?t:[t]);if(f.size<=0)return!1;d.value.keys=d.value.keys.filter((l,i)=>!f.has(i));const o=b.filter((l,i)=>!f.has(i));return _(o),h.onFieldChange(),Promise.resolve().then(()=>{var l;(l=e.onAfterRemove)==null||l.call(e,t,v.value)}),!0}},F=async()=>{var t;if(e.creatorButtonProps!==!1){S.value=!0;let a=v.value;((t=e.creatorButtonProps)==null?void 0:t.position)==="top"&&(a=0),await y.add(I(B(e.creatorRecord)||{}),a),S.value=!1}},T=async t=>{await y.remove(t)},j=async t=>{await y.add(I(w.value[t]),v.value+1)};me(w,()=>{var t;ae(r.value,w.value)||(r.value=I((t=w.value)!=null?t:[]))},{immediate:!0});const R=s(()=>{var t,a;if(e.readonly||e.creatorButtonProps===!1||v.value===e.max)return null;const{position:m="bottom",creatorButtonText:c="添加一行数据"}=(t=e.creatorButtonProps)!=null?t:{},{block:b=!0,type:f="dashed",...o}=oe((a=e.creatorButtonProps)!=null?a:{},["position","creatorButtonText"]),l=n(ie,z({class:`${A}-list-creator-button-${m}`,type:f,block:b,icon:n(ne,null,null)},o,{loading:S.value,onClick:F}),be(c)?c:{default:()=>[c]});return P.creator?n(O,{vnode:P.creator,props:{defaultDom:l,add:y.add,count:v.value}},null):l});return()=>{var t,a,m,c,b,f,o;return e.readonly&&!((t=r.value)!=null&&t.length)&&(r.value=[{}]),n("div",{style:"width: max-content; max-width: 100%; min-width: 100%; ",class:{[`${A}-list-container`]:!0,[`${A}-list-empty`]:((m=(a=w.value)!=null?a:[])==null?void 0:m.length)==0}},[e.creatorButtonProps!==!1&&((c=e.creatorButtonProps)==null?void 0:c.position)==="top"&&R.value,((b=r.value)!=null?b:[]).map((l,i)=>{let u=d.value.keys[i];return u===void 0&&(d.value.keys[i]=d.value.id,u=d.value.keys[i],d.value.id+=1),n(we,{key:u,fieldKey:u,originName:e.originName,index:i,items:e.items,rowProps:e.rowProps,min:e.min,max:e.max,count:v.value,record:l,title:e.title,rowTitle:e.rowTitle,rowTitleStyle:e.rowTitleStyle,alwaysShowItemLabel:e.alwaysShowItemLabel,alwaysShowRowTitle:e.alwaysShowRowTitle,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,action:y,readonly:e.readonly,onRemove:T,onCopy:j},{action:P.action,item:P.item})}),e.creatorButtonProps!==!1&&(((f=e.creatorButtonProps)==null?void 0:f.position)==="bottom"||((o=e.creatorButtonProps)==null?void 0:o.position)===void 0)&&R.value])}}});const Pe=["autoLink","colon","hasFeedback","labelAlign","labelCol","required","validateFirst","validateStatus","validateTrigger","wrapperCol","required"];var Ae=x({name:"FormList",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},colProps:{type:Object,default:void 0},rowProps:{type:Object,default:void 0},formItemProps:{type:[Object,Function],default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},readonly:{type:Boolean,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},alwaysShowRowTitle:{type:Boolean,default:!0},rowTitle:{type:String,default:void 0},rowTitleStyle:{type:Object,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},rules:{type:[Object,Array,Function],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},isValidateList:{type:Boolean,default:void 0},emptyListMessage:{type:String,default:"列表不能为空"},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:P}){const{formatItems:S,formData:r,prefixCls:A,readonly:d}=V(),w=q(),_=s(()=>{var t;return B((t=e.readonly)!=null?t:d?.value,r.value)}),h=s(()=>{var t;return((t=w.listName)==null?void 0:t.value)===void 0?[e.originName].flat(1):[w.listName.value,e.originName].flat(1)}),v=s(()=>{var t;return(t=B(e.formItemProps,r.value))!=null?t:{}}),y=s(()=>{var t;return ue({rules:_.value?[]:B((t=e.rules)!=null?t:v.value.rules,r.value),...re(v.value,Pe)})}),F=s(()=>{var t,a;return(a=S?.(B((t=e.items)!=null?t:[],r.value)))!=null?a:[]}),T=s(()=>{const t={};return e.title&&(t.label=()=>n(de,{title:e.title,tooltip:e.tooltip},null)),t}),j=(...t)=>{var a;(a=e.onAfterAdd)==null||a.call(e,...t)},R=(...t)=>{var a;(a=e.onAfterRemove)==null||a.call(e,...t)};return()=>{var t;if(!((t=e.name)!=null&&t.length)||!F.value.length)return null;const a=e.isValidateList?[{validator:(m,c)=>!c||c.length===0?Promise.reject(new Error(e.emptyListMessage)):Promise.resolve(),required:!0}]:B(e.rules,r.value);return n(ce,{colProps:e.colProps},{default:()=>{var m,c;return[n("div",{class:`${A}-list`},[n(W.Item,z({required:_.value?!1:(c=(m=y.value)==null?void 0:m.rules)==null?void 0:c.some(b=>b.required),name:a?.length?h.value:void 0,rules:_.value?void 0:a},y.value),{default:()=>[n(ge,{name:e.name,originName:e.originName,title:e.title,rowTitle:e.rowTitle,rowTitleStyle:e.rowTitleStyle,tooltip:e.tooltip,rowProps:e.rowProps,initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform,items:F.value,min:e.min,max:e.max,readonly:_.value,alwaysShowItemLabel:e.alwaysShowItemLabel,alwaysShowRowTitle:e.alwaysShowRowTitle,creatorRecord:e.creatorRecord,creatorButtonProps:e.creatorButtonProps,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,actionGuard:e.actionGuard,onAfterAdd:j,onAfterRemove:R},{...P})],...T.value})])]}})}}});export{Ae as default};
