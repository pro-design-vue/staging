import{A as p,_ as K,z,$ as C,B as F,a0 as U,H as x,K as O,a1 as D,O as $,a2 as W,a3 as M,L as Y,J as H,Z as h,d as J,F as _,X,a4 as Z,a5 as Q,u as ee,U as te,V as ne}from"./theme.Bhb4irpg.js";import{F as ae,a as oe}from"./FormTitle.Btbg4AL0.js";import{u as le}from"./useFieldValue.eIXA5b8r.js";import{d as V,f as L,c as d,k as n,s as ie,w as ue,a0 as G,i as re}from"./framework.B0enweWD.js";const de=["formSet","divider"],ce=V({name:"FormListItem",inheritAttrs:!1,props:{index:{type:Number,default:0},originName:{type:[String,Array],default:()=>[]},fieldKey:{type:Number,default:0},title:{type:[String,Object,Function],default:void 0},items:{type:Array,default:()=>[]},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},copyIconProps:{type:[Object,Boolean],default:void 0},deleteIconProps:{type:[Object,Boolean],default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},alwaysShowRowTitle:{type:Boolean,default:void 0},rowTitle:{type:String,default:void 0},rowTitleStyle:{type:Object,default:void 0},count:{type:Number,default:0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},record:{type:Object,default:void 0},action:{type:Object,required:!0},onRemove:{type:Function,required:!0},onCopy:{type:Function,required:!0}},emits:["remove","copy"],setup(e,{slots:y}){const{formatItems:I,prefixCls:l,formData:g,grid:u}=p(),f=K(),v=z(),w=L(!1),c=L(!1),s=d(()=>e.index),P=d(()=>[f.listName?.value,e.originName,s.value].filter(r=>r!==void 0).flat(1)),B=d(()=>[f.listKey,C(e.originName),e.fieldKey].filter(r=>r!==void 0).flat(1).join("_")),j=r=>{const a=[];return r.dependencies?.forEach(m=>{const S=C(m);S&&a.push([...P.value,S].filter(N=>N!==void 0).flat(1))}),a},A=r=>h(r).filter(a=>!de.includes(a.fieldType??"")).map(a=>{if(a.fieldType===J.GROUP)return a.children=A(F(a.children??[],g.value)??[]),a;const m=a.originName??a.name,S=a.originKey??a.key,N=C(a.name),q=s.value===0||e.alwaysShowItemLabel?a.title:void 0,k={...a,title:q,originKey:S,key:`${B.value}_${a.key??N?.join("_")}`,originName:m,name:[...P?.value??[],N].filter(E=>E!==void 0).flat(1)};return Array.isArray(a.dependencies)&&a.dependencies.length>0&&a.name&&(k.dependencies=j(k)),k}),t=d(()=>{const r=F(e.items??[],g.value)??[];return I?.(A(r))??[]}),o=d(()=>e.alwaysShowRowTitle&&e.rowTitle),i=d(()=>{if(e.readonly||e.deleteIconProps===!1||e.min===e.count)return null;const{icon:r,tooltipText:a}=e.deleteIconProps??{};let m=n(U,null,null);if(r){const S=x(r,v);m=n(O,{vnode:S,props:{defaultDom:m}},null)}return n(D,{size:"small",spinning:w.value},{default:()=>[n($,{title:a??"删除此行",key:"delete"},{default:()=>[n("div",{class:`${l}-list-action-icon ${l}-list-action-remove`,onClick:T},[m])]})]})}),R=d(()=>{if(e.readonly||e.copyIconProps===!1||e.max===e.count)return null;const{icon:r,tooltipText:a}=e.copyIconProps??{};let m=n(W,null,null);if(r){const S=x(r,v);m=n(O,{vnode:S,props:{defaultDom:m}},null)}return n(D,{size:"small",spinning:c.value},{default:()=>[n($,{title:a??"复制此行",key:"copy"},{default:()=>[n("div",{class:`${l}-list-action-icon ${l}-list-action-copy`,onClick:b},[m])]})]})}),T=async()=>{w.value=!0,await e.onRemove(s.value),w.value=!1},b=async()=>{c.value=!0,await e.onCopy(s.value),c.value=!1};return M({isList:!0,originName:e.originName,index:s,fieldKey:e.fieldKey,listName:P,listKey:B.value,rowData:d(()=>e.record)}),()=>{if(!t.value.length)return null;const r=n("div",{class:`${l}-list-action`},[R.value,i.value]),a=y.action?n(O,{vnode:y.action,props:{index:s.value,action:e.action,defaultDom:r,record:e.record??{}}},null):r,m=n("div",{class:`${l}-list-item-container`,style:{width:u?.value?"100%":void 0}},[n(Y,{rowProps:e.rowProps},{default:()=>[n(H,{list:t.value},null)]})]);return y.item?n(O,{vnode:y.item,props:{listDom:m,actionDom:a,record:e.record??{}}},null):n("div",{class:`${l}-list-item-wrapper`},[o.value&&n("div",{class:`${l}-list-item-title`},[n("div",{style:e.rowTitleStyle},[e.rowTitle,e.index+1]),a]),n("div",{class:`${l}-list-item`,style:"display: flex; align-items: flex-end;"},[m,!o.value&&a])])}}});function se(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!re(e)}const fe=V({name:"FormListContainer",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},alwaysShowRowTitle:{type:Boolean,default:void 0},rowTitle:{type:String,default:void 0},rowTitleStyle:{type:Object,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:y}){const I=L(!1),l=L([]),{prefixCls:g}=p(),u=ie({keys:[],id:0}),{fieldValue:f,onValueChange:v}=le({namePath:d(()=>e.name),initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform}),w=_.useInjectFormItemContext(),c=d(()=>f.value?.length??0),s={add:async(t,o)=>{if(e.actionGuard?.beforeAddRow&&!await e.actionGuard?.beforeAddRow(t,o,c.value))return!1;const i=h(f.value??[]);return o!==void 0&&o>=0&&o<=i.length?(u.value.keys=[...u.value.keys.slice(0,o),u.value.id,...u.value.keys.slice(o)],v(h([...i.slice(0,o),t,...i.slice(o)])),w.onFieldChange()):(u.value.keys=[...u.value.keys,u.value.id],v(h([...i,t])),w.onFieldChange()),u.value.id+=1,Promise.resolve().then(()=>{e.onAfterAdd?.(t,o,c.value)}),!0},remove:async t=>{if(e.actionGuard?.beforeRemoveRow&&!await e.actionGuard?.beforeRemoveRow(t,c.value))return!1;const o=h(f.value??[]),i=new Set(Array.isArray(t)?t:[t]);if(i.size<=0)return!1;u.value.keys=u.value.keys.filter((T,b)=>!i.has(b));const R=o.filter((T,b)=>!i.has(b));return v(R),w.onFieldChange(),Promise.resolve().then(()=>{e.onAfterRemove?.(t,c.value)}),!0}},P=async()=>{if(e.creatorButtonProps!==!1){I.value=!0;let t=c.value;e.creatorButtonProps?.position==="top"&&(t=0),await s.add(h(F(e.creatorRecord)||{}),t),I.value=!1}},B=async t=>{await s.remove(t)},j=async t=>{await s.add(h(f.value[t]),c.value+1)};ue(f,()=>{X(l.value,f.value)||(l.value=h(f.value??[]))},{immediate:!0});const A=d(()=>{if(e.readonly||e.creatorButtonProps===!1||c.value===e.max)return null;const{position:t="bottom",creatorButtonText:o="添加一行数据"}=e.creatorButtonProps??{},{block:i=!0,type:R="dashed",...T}=Z(e.creatorButtonProps??{},["position","creatorButtonText"]),b=n(Q,G({class:`${g}-list-creator-button-${t}`,type:R,block:i,icon:n(ee,null,null)},T,{loading:I.value,onClick:P}),se(o)?o:{default:()=>[o]});return y.creator?n(O,{vnode:y.creator,props:{defaultDom:b,add:s.add,count:c.value}},null):b});return()=>(e.readonly&&!l.value?.length&&(l.value=[{}]),n("div",{style:"width: max-content; max-width: 100%; min-width: 100%; ",class:{[`${g}-list-container`]:!0,[`${g}-list-empty`]:(f.value??[])?.length==0}},[e.creatorButtonProps!==!1&&e.creatorButtonProps?.position==="top"&&A.value,(l.value??[]).map((t,o)=>{let i=u.value.keys[o];return i===void 0&&(u.value.keys[o]=u.value.id,i=u.value.keys[o],u.value.id+=1),n(ce,{key:i,fieldKey:i,originName:e.originName,index:o,items:e.items,rowProps:e.rowProps,min:e.min,max:e.max,count:c.value,record:t,title:e.title,rowTitle:e.rowTitle,rowTitleStyle:e.rowTitleStyle,alwaysShowItemLabel:e.alwaysShowItemLabel,alwaysShowRowTitle:e.alwaysShowRowTitle,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,action:s,readonly:e.readonly,onRemove:B,onCopy:j},{action:y.action,item:y.item})}),e.creatorButtonProps!==!1&&(e.creatorButtonProps?.position==="bottom"||e.creatorButtonProps?.position===void 0)&&A.value]))}}),me=["autoLink","colon","hasFeedback","labelAlign","labelCol","required","validateFirst","validateStatus","validateTrigger","wrapperCol","required"],Pe=V({name:"FormList",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},colProps:{type:Object,default:void 0},rowProps:{type:Object,default:void 0},formItemProps:{type:[Object,Function],default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},readonly:{type:Boolean,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},alwaysShowRowTitle:{type:Boolean,default:!0},rowTitle:{type:String,default:void 0},rowTitleStyle:{type:Object,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},rules:{type:[Object,Array,Function],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},isValidateList:{type:Boolean,default:void 0},emptyListMessage:{type:String,default:"列表不能为空"},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:y}){const{formatItems:I,formData:l,prefixCls:g,readonly:u}=p(),f=K(),v=d(()=>F(e.readonly??u?.value,l.value)),w=d(()=>f.listName?.value===void 0?[e.originName].flat(1):[f.listName.value,e.originName].flat(1)),c=d(()=>F(e.formItemProps,l.value)??{}),s=d(()=>te({rules:v.value?[]:F(e.rules??c.value.rules,l.value),...ne(c.value,me)})),P=d(()=>I?.(F(e.items??[],l.value))??[]),B=d(()=>{const t={};return e.title&&(t.label=()=>n(ae,{title:e.title,tooltip:e.tooltip},null)),t}),j=(...t)=>{e.onAfterAdd?.(...t)},A=(...t)=>{e.onAfterRemove?.(...t)};return()=>{if(!e.name?.length||!P.value.length)return null;const t=e.isValidateList?[{validator:(o,i)=>!i||i.length===0?Promise.reject(new Error(e.emptyListMessage)):Promise.resolve(),required:!0}]:F(e.rules,l.value);return n(oe,{colProps:e.colProps},{default:()=>[n("div",{class:`${g}-list`},[n(_.Item,G({required:v.value?!1:s.value?.rules?.some(o=>o.required),name:t?.length?w.value:void 0,rules:v.value?void 0:t},s.value),{default:()=>[n(fe,{name:e.name,originName:e.originName,title:e.title,rowTitle:e.rowTitle,rowTitleStyle:e.rowTitleStyle,tooltip:e.tooltip,rowProps:e.rowProps,initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform,items:P.value,min:e.min,max:e.max,readonly:v.value,alwaysShowItemLabel:e.alwaysShowItemLabel,alwaysShowRowTitle:e.alwaysShowRowTitle,creatorRecord:e.creatorRecord,creatorButtonProps:e.creatorButtonProps,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,actionGuard:e.actionGuard,onAfterAdd:j,onAfterRemove:A},{...y})],...B.value})])]})}}});export{Pe as default};
