import{B as D,W as E,A as J,X as p,G as B,Y as Q,J as K,L as S,Z as T,_ as G,$ as X,a0 as Z,N as H,K as ee,a1 as h,d as te,F as q,V as ae,a2 as oe,t as le,a3 as ne,O as ie,Q as ue}from"./theme.S8A6BGPI.js";import{F as re,a as de}from"./FormTitle.Cyr4o4jG.js";import{u as ce}from"./useFieldValue.DcWkYE0G.js";import{d as V,f as R,e as f,k as i,s as se,w as ve,a0 as W,i as me}from"./framework.BXLl-MbO.js";const fe=["formSet","divider"];var ye=V({name:"FormListItem",inheritAttrs:!1,props:{index:{type:Number,default:0},originName:{type:[String,Array],default:()=>[]},fieldKey:{type:Number,default:0},items:{type:Array,default:()=>[]},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},copyIconProps:{type:[Object,Boolean],default:void 0},deleteIconProps:{type:[Object,Boolean],default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},count:{type:Number,default:0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},record:{type:Object,default:void 0},action:{type:Object,required:!0},onRemove:{type:Function,required:!0},onCopy:{type:Function,required:!0}},emits:["remove","copy"],setup(e,{slots:P}){const{formatItems:w,prefixCls:c,formData:I,grid:r}=D(),b=E(),_=J(),A=R(!1),v=R(!1),y=f(()=>e.index),F=f(()=>{var l;return[(l=b.listName)==null?void 0:l.value,e.originName,y.value].filter(a=>a!==void 0).flat(1)}),j=f(()=>[b.listKey,p(e.originName),e.fieldKey].filter(l=>l!==void 0).flat(1).join("_")),O=l=>{var a;const n=[];return(a=l.dependencies)==null||a.forEach(u=>{const s=p(u);s&&n.push([...F.value,s].filter(C=>C!==void 0).flat(1))}),n},N=l=>h(l).filter(a=>{var n;return!fe.includes((n=a.fieldType)!=null?n:"")}).map(a=>{var n,u,s,C,x,$;if(a.fieldType===te.GROUP)return a.children=N((u=B((n=a.children)!=null?n:[],I.value))!=null?u:[]),a;const z=(s=a.originName)!=null?s:a.name,Y=(C=a.originKey)!=null?C:a.key,L=p(a.name),M=y.value===0||e.alwaysShowItemLabel?a.title:void 0,k={...a,title:M,originKey:Y,key:`${j.value}_${(x=a.key)!=null?x:L?.join("_")}`,originName:z,name:[...($=F?.value)!=null?$:[],L].filter(U=>U!==void 0).flat(1)};return Array.isArray(a.dependencies)&&a.dependencies.length>0&&a.name&&(k.dependencies=O(k)),k}),t=f(()=>{var l,a,n;const u=(a=B((l=e.items)!=null?l:[],I.value))!=null?a:[];return(n=w?.(N(u)))!=null?n:[]}),o=f(()=>{var l;if(e.readonly||e.deleteIconProps===!1||e.min===e.count)return null;const{icon:a,tooltipText:n}=(l=e.deleteIconProps)!=null?l:{};let u=i(Q,null,null);if(a){const s=K(a,_);u=i(S,{vnode:s,props:{defaultDom:u}},null)}return i(G,{size:"small",spinning:A.value},{default:()=>[i(T,{title:n??"删除此行",key:"delete"},{default:()=>[i("div",{class:`${c}-list-action-icon ${c}-list-action-remove`,onClick:d},[u])]})]})}),m=f(()=>{var l;if(e.readonly||e.copyIconProps===!1||e.max===e.count)return null;const{icon:a,tooltipText:n}=(l=e.copyIconProps)!=null?l:{};let u=i(X,null,null);if(a){const s=K(a,_);u=i(S,{vnode:s,props:{defaultDom:u}},null)}return i(G,{size:"small",spinning:v.value},{default:()=>[i(T,{title:n??"复制此行",key:"copy"},{default:()=>[i("div",{class:`${c}-list-action-icon ${c}-list-action-copy`,onClick:g},[u])]})]})}),d=async()=>{A.value=!0,await e.onRemove(y.value),A.value=!1},g=async()=>{v.value=!0,await e.onCopy(y.value),v.value=!1};return Z({isList:!0,originName:e.originName,index:y,fieldKey:e.fieldKey,listName:F,listKey:j.value,rowData:f(()=>e.record)}),()=>{var l,a;if(!t.value.length)return null;const n=i("div",{class:`${c}-list-action`},[m.value,o.value]),u=P.action?i(S,{vnode:P.action,props:{index:y.value,action:e.action,defaultDom:n,record:(l=e.record)!=null?l:{}}},null):n,s=i("div",{class:`${c}-list-item-container`,style:{width:r?.value?"100%":void 0}},[i(H,{rowProps:e.rowProps},{default:()=>[i(ee,{list:t.value},null)]})]);return P.item?i(S,{vnode:P.item,props:{listDom:s,actionDom:u,record:(a=e.record)!=null?a:{}}},null):i("div",{class:`${c}-list-item`,style:"display: flex; align-items: flex-end;"},[s,u])}}});function be(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!me(e)}var ge=V({name:"FormListContainer",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:P}){const w=R(!1),c=R([]),{prefixCls:I}=D(),r=se({keys:[],id:0}),{fieldValue:b,onValueChange:_}=ce({namePath:f(()=>e.name),initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform}),A=q.useInjectFormItemContext(),v=f(()=>{var t,o;return(o=(t=b.value)==null?void 0:t.length)!=null?o:0}),y={add:async(t,o)=>{var m,d,g;if((m=e.actionGuard)!=null&&m.beforeAddRow&&!await((d=e.actionGuard)==null?void 0:d.beforeAddRow(t,o,v.value)))return!1;const l=h((g=b.value)!=null?g:[]);return o!==void 0&&o>=0&&o<=l.length?(r.value.keys=[...r.value.keys.slice(0,o),r.value.id,...r.value.keys.slice(o)],_(h([...l.slice(0,o),t,...l.slice(o)])),A.onFieldChange()):(r.value.keys=[...r.value.keys,r.value.id],_(h([...l,t])),A.onFieldChange()),r.value.id+=1,Promise.resolve().then(()=>{var a;(a=e.onAfterAdd)==null||a.call(e,t,o,v.value)}),!0},remove:async t=>{var o,m,d;if((o=e.actionGuard)!=null&&o.beforeRemoveRow&&!await((m=e.actionGuard)==null?void 0:m.beforeRemoveRow(t,v.value)))return!1;const g=h((d=b.value)!=null?d:[]),l=new Set(Array.isArray(t)?t:[t]);if(l.size<=0)return!1;r.value.keys=r.value.keys.filter((n,u)=>!l.has(u));const a=g.filter((n,u)=>!l.has(u));return _(a),A.onFieldChange(),Promise.resolve().then(()=>{var n;(n=e.onAfterRemove)==null||n.call(e,t,v.value)}),!0}},F=async()=>{var t;if(e.creatorButtonProps!==!1){w.value=!0;let o=v.value;((t=e.creatorButtonProps)==null?void 0:t.position)==="top"&&(o=0),await y.add(h(B(e.creatorRecord)||{}),o),w.value=!1}},j=async t=>{await y.remove(t)},O=async t=>{await y.add(h(b.value[t]),v.value+1)};ve(b,()=>{var t;ae(c.value,b.value)||(c.value=h((t=b.value)!=null?t:[]))},{immediate:!0});const N=f(()=>{var t,o;if(e.readonly||e.creatorButtonProps===!1||v.value===e.max)return null;const{position:m="bottom",creatorButtonText:d="添加一行数据"}=(t=e.creatorButtonProps)!=null?t:{},{block:g=!0,type:l="dashed",...a}=oe((o=e.creatorButtonProps)!=null?o:{},["position","creatorButtonText"]),n=i(ne,W({class:`${I}-list-creator-button-${m}`,type:l,block:g,icon:i(le,null,null)},a,{loading:w.value,onClick:F}),be(d)?d:{default:()=>[d]});return P.creator?i(S,{vnode:P.creator,props:{defaultDom:n,add:y.add,count:v.value}},null):n});return()=>{var t,o,m,d,g,l,a;return e.readonly&&!((t=c.value)!=null&&t.length)&&(c.value=[{}]),i("div",{style:"width: max-content; max-width: 100%; min-width: 100%; ",class:{[`${I}-list-container`]:!0,[`${I}-list-empty`]:((m=(o=b.value)!=null?o:[])==null?void 0:m.length)==0}},[e.creatorButtonProps!==!1&&((d=e.creatorButtonProps)==null?void 0:d.position)==="top"&&N.value,((g=c.value)!=null?g:[]).map((n,u)=>{let s=r.value.keys[u];return s===void 0&&(r.value.keys[u]=r.value.id,s=r.value.keys[u],r.value.id+=1),i(ye,{key:s,fieldKey:s,originName:e.originName,index:u,items:e.items,rowProps:e.rowProps,min:e.min,max:e.max,count:v.value,record:n,alwaysShowItemLabel:e.alwaysShowItemLabel,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,action:y,readonly:e.readonly,onRemove:j,onCopy:O},{action:P.action,item:P.item})}),e.creatorButtonProps!==!1&&(((l=e.creatorButtonProps)==null?void 0:l.position)==="bottom"||((a=e.creatorButtonProps)==null?void 0:a.position)===void 0)&&N.value])}}});const Pe=["autoLink","colon","hasFeedback","labelAlign","labelCol","required","validateFirst","validateStatus","validateTrigger","wrapperCol","required"];var Ie=V({name:"FormList",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},colProps:{type:Object,default:void 0},rowProps:{type:Object,default:void 0},formItemProps:{type:[Object,Function],default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},readonly:{type:Boolean,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},rules:{type:[Object,Array,Function],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},isValidateList:{type:Boolean,default:void 0},emptyListMessage:{type:String,default:"列表不能为空"},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:P}){const{formatItems:w,formData:c,prefixCls:I,readonly:r}=D(),b=E(),_=f(()=>{var t;return B((t=e.readonly)!=null?t:r?.value,c.value)}),A=f(()=>{var t;return((t=b.listName)==null?void 0:t.value)===void 0?[e.originName].flat(1):[b.listName.value,e.originName].flat(1)}),v=f(()=>{var t;return(t=B(e.formItemProps,c.value))!=null?t:{}}),y=f(()=>{var t;return ie({rules:_.value?[]:B((t=e.rules)!=null?t:v.value.rules,c.value),...ue(v.value,Pe)})}),F=f(()=>{var t,o;return(o=w?.(B((t=e.items)!=null?t:[],c.value)))!=null?o:[]}),j=f(()=>{const t={};return e.title&&(t.label=()=>i(re,{title:e.title,tooltip:e.tooltip},null)),t}),O=(...t)=>{var o;(o=e.onAfterAdd)==null||o.call(e,...t)},N=(...t)=>{var o;(o=e.onAfterRemove)==null||o.call(e,...t)};return()=>{var t;if(!((t=e.name)!=null&&t.length)||!F.value.length)return null;const o=e.isValidateList?[{validator:(m,d)=>!d||d.length===0?Promise.reject(new Error(e.emptyListMessage)):Promise.resolve(),required:!0}]:B(e.rules,c.value);return i(de,{colProps:e.colProps},{default:()=>{var m,d;return[i("div",{class:`${I}-list`},[i(q.Item,W({required:_.value?!1:(d=(m=y.value)==null?void 0:m.rules)==null?void 0:d.some(g=>g.required),name:o?.length?A.value:void 0,rules:_.value?void 0:o},y.value),{default:()=>[i(ge,{name:e.name,originName:e.originName,title:e.title,tooltip:e.tooltip,rowProps:e.rowProps,initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform,items:F.value,min:e.min,max:e.max,readonly:_.value,alwaysShowItemLabel:e.alwaysShowItemLabel,creatorRecord:e.creatorRecord,creatorButtonProps:e.creatorButtonProps,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,actionGuard:e.actionGuard,onAfterAdd:O,onAfterRemove:N},{...P})],...j.value})])]}})}}});export{Ie as default};
